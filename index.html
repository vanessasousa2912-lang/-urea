<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Áurea - IA Lab Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #020617; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .active-chat { background: rgba(245, 158, 11, 0.1); border-left: 3px solid #f59e0b; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 flex flex-col md:flex-row min-h-screen">

    <!-- Sidebar -->
    <aside class="w-full md:w-64 border-r border-white/5 bg-slate-950 flex flex-col md:h-screen sticky top-0">
        <div class="p-4 border-b border-white/5">
            <button id="sidebar-new-chat" class="w-full flex items-center justify-center gap-2 bg-slate-900 hover:bg-slate-800 border border-white/10 p-3 rounded-xl transition-all text-sm font-semibold text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                <span>Novo Chat</span>
            </button>
        </div>
        <div id="history-list" class="flex-grow overflow-y-auto p-2 custom-scrollbar space-y-1"></div>
        <div class="p-4 text-[10px] text-slate-600 text-center border-t border-white/5">Áurea v3.5 Cloud</div>
    </aside>

    <div class="flex-grow flex flex-col relative">
        <nav class="w-full border-b border-white/5 bg-slate-950/80 backdrop-blur-md sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
                <h1 class="text-xl font-bold bg-gradient-to-r from-amber-400 to-yellow-600 bg-clip-text text-transparent italic">Áurea Lab</h1>
                <div id="connection-status" class="flex items-center gap-2 glass px-3 py-1 rounded-full text-[10px] uppercase text-slate-400">
                    <span class="w-2 h-2 bg-slate-600 rounded-full"></span>
                    <span>Offline</span>
                </div>
            </div>
        </nav>

        <main class="p-4 md:p-6 flex-grow">
            <div class="max-w-4xl mx-auto">
                <section class="glass p-4 md:p-6 rounded-2xl flex flex-col h-[600px] shadow-2xl">
                    <div id="chat-output" class="flex-grow overflow-y-auto mb-4 space-y-4 pr-3 text-sm custom-scrollbar">
                        <div class="text-slate-500 text-center mt-20 italic">Pronto para começar o laboratório?</div>
                    </div>
                   
                    <div class="pt-4 border-t border-white/10">
                        <div id="typing-indicator" class="hidden text-[10px] text-amber-500 animate-pulse mb-2 font-bold uppercase">Áurea está a processar no servidor...</div>
                        <div class="relative flex gap-2">
                            <textarea id="chat-input" class="flex-grow bg-slate-900 border border-white/5 rounded-xl p-3 text-sm focus:border-amber-500 outline-none transition-all text-white h-14 resize-none" placeholder="Pergunta algo ao teu servidor..."></textarea>
                            <button id="send-btn" class="bg-amber-600 hover:bg-amber-500 px-5 rounded-xl text-white transition-transform active:scale-95">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
                            </button>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'ia-lab-luis';

        // DETEÇÃO AUTOMÁTICA DO BACKEND
        // Se estiveres a correr no Render, ele usa o URL do Render. Se for local, usa localhost.
        const backendUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
            ? 'http://localhost:3000/api/chat' 
            : '/api/chat';

        let user = null;
        let currentSessionId = null;
        let chatHistory = [];
        let sessions = [];

        async function initAuth() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else { await signInAnonymously(auth); }
        }
        initAuth();

        onAuthStateChanged(auth, (u) => {
            user = u;
            if (user) {
                document.getElementById('connection-status').innerHTML = `<span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span><span class="text-emerald-400">Server Link Active</span>`;
                setupFirestoreListeners();
            }
        });

        function setupFirestoreListeners() {
            const sessionsPath = collection(db, 'artifacts', appId, 'users', user.uid, 'sessions');
            onSnapshot(sessionsPath, (snapshot) => {
                sessions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                    .sort((a, b) => (b.updatedAt?.seconds || 0) - (a.updatedAt?.seconds || 0));
                renderHistory();
                if (!currentSessionId && sessions.length > 0) loadSession(sessions[0].id);
                else if (sessions.length === 0) startNewChat();
            });
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            sessions.forEach(s => {
                const div = document.createElement('div');
                div.className = `p-3 rounded-lg cursor-pointer text-xs transition-all border border-transparent ${s.id === currentSessionId ? 'active-chat font-bold' : 'hover:bg-white/5'}`;
                div.onclick = () => loadSession(s.id);
                div.innerText = s.title || 'Nova Conversa';
                list.appendChild(div);
            });
        }

        function loadSession(id) {
            currentSessionId = id;
            const session = sessions.find(s => s.id === id);
            if (session) {
                chatHistory = session.history || [];
                const out = document.getElementById('chat-output');
                out.innerHTML = '';
                chatHistory.forEach(msg => appendChat(msg.role === 'user' ? 'user' : 'assistant', msg.parts[0].text));
                renderHistory();
            }
        }

        async function startNewChat() {
            currentSessionId = Date.now().toString();
            const sessionDoc = doc(db, 'artifacts', appId, 'users', user.uid, 'sessions', currentSessionId);
            await setDoc(sessionDoc, { title: 'Nova Conversa', history: [], updatedAt: serverTimestamp() });
        }

        function appendChat(role, text) {
            const out = document.getElementById('chat-output');
            const div = document.createElement('div');
            const isU = role === 'user';
            div.className = `flex ${isU ? 'justify-end' : 'justify-start'} w-full mb-4`;
            div.innerHTML = `<div class="max-w-[85%] p-4 rounded-2xl ${isU ? 'bg-amber-600/20 text-amber-100' : 'bg-slate-900 text-slate-200 border border-white/5'} text-sm">${marked.parse(text)}</div>`;
            out.appendChild(div);
            out.scrollTop = out.scrollHeight;
        }

        async function handleSend() {
            const input = document.getElementById('chat-input');
            const val = input.value.trim();
            if (!val || !user || !currentSessionId) return;

            input.value = '';
            appendChat('user', val);
            document.getElementById('typing-indicator').classList.remove('hidden');
            chatHistory.push({ role: "user", parts: [{ text: val }] });

            try {
                const response = await fetch(backendUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: chatHistory })
                });
               
                const data = await response.json();
                const reply = data.candidates[0].content.parts[0].text;
                
                chatHistory.push({ role: "model", parts: [{ text: reply }] });
                appendChat('assistant', reply);

                const sessionDoc = doc(db, 'artifacts', appId, 'users', user.uid, 'sessions', currentSessionId);
                await updateDoc(sessionDoc, {
                    history: chatHistory,
                    updatedAt: serverTimestamp(),
                    title: chatHistory.length <= 2 ? val.slice(0, 20) : sessions.find(s => s.id === currentSessionId).title
                });
            } catch (e) {
                appendChat('assistant', "❌ Erro ao ligar ao servidor. Verifica o Render.");
            } finally {
                document.getElementById('typing-indicator').classList.add('hidden');
            }
        }

        document.getElementById('send-btn').onclick = handleSend;
        document.getElementById('chat-input').onkeydown = e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); } };
        document.getElementById('sidebar-new-chat').onclick = startNewChat;
    </script>
</body>
</html>